# inquis_gen_3_0

## Overview.

The system is comprised of two separate MCUs with their own .ioc files.
They are organized into two sub-folders: `cms/` and `handle/`.
Both are based on the [STM32L471RET](https://www.st.com/en/microcontrollers-microprocessors/stm32l471re.html) processor.

### cms

The Clot Management System (CMS) is the the base-device
which is the logic-master for user-visible state. It also houses an SD Card and
is responsible for logging data. It manages the power to the handle so
is also responsible for boot-up management.


### handle

The handle is connected to the CMS with a bi-driectional data and power connection.
The handle is responsible for measuring the impedance via the AD5940 sensor. It
runs a state machine to manage what it thinks is the clot state and
forwards that information to the CMS. It receives LED UI state information
from the CMS and uses that to set local LED state (which may be mirrored on the CMS.)

### common

There is some code that is shared between the two systems in `common/`


## Development

### Setup

1. When importing the project into the STM Cube IDE it must have
the .cproject, .mxproject, .project, .settings files/folders.

1. From the IDE File -- Import -- general -- Existing Projects into Workspace -- Next -- Select the root -- Finish

1. If it work correcly it will show the IDE icon in the Explorer and Right-click -- Properties -- C/C++ Build -- will show C config. If it isn't there it is because one of the aforementioned dot files/folders is missing.

1. After importing you have to point the common/ folder that is under the cms/ and handle/ fodlers to the correct location.

1. Right-click common/ -- Properties -- Resource -- Location -- Edit... and change to this project's common/ folder.

1. When it is correct the common folder will show a link and you will see the contents.

1. Run the following command, as done in build.sh, to create the necessary audio file
    ```
    xxd -i ./media/audio0.wav > ./cms/inquis/_audio0.h
    ```

1. Build both projects from the IDE once. Then you can start to use the CLI tools (build.sh, package.sh, etc.)

### Formatting

We use a .clang-format file.

clang is installed on Windows via mingw64.

```bash
$ ./format.sh # runs clang on all inquis source (does not touch code generated by CubeIDE, libs, etc.)
```

There's also a task in the .vscode/tasks.json called "Clang Format".

To bind that to a key:

Press `Ctrl + Shift + P` and type "Preferences: Open Keyboard Shortcuts (JSON)" and select it. Add...

```json
[
    {
        "key": "shift+alt+f",
        "command": "workbench.action.tasks.runTask",
        "args": "Clang Format"
    }
]
```

### Build from CLI

Note the crazy paths that are version specific. :-(.
Here's my `~/.bashrc` from inside mingw64.

```bash
$ cat ~/.bashrc
export PATH="/c/ST/STM32CubeIDE_1.11.0/STM32CubeIDE/plugins/com.st.stm32cube.ide.mcu.externaltools.cubeprogrammer.win32_2.1.201.202404072231/tools/bin\
:/c/ST/STM32CubeIDE_1.11.0/STM32CubeIDE/plugins/com.st.stm32cube.ide.mcu.externaltools.gnu-tools-for-stm32.12.3.rel1.win32_1.0.100.202403111256/tools/bin/\
:/c/ST/STM32CubeIDE_1.11.0/STM32CubeIDE/plugins/com.st.stm32cube.ide.mcu.externaltools.make.win32_2.1.300.202402091052/tools/bin\
:$PATH"
```

With those paths you build hex files from the CLI.

For example:

```bash
$ cd ./handle/Debug
$ make gen_3_0_handle.hex
```

### Flash from the CLI

```bash
./update_handle.sh
```

### Identify the SWD Programming Devices

```bash
$ STM32_Programmer_CLI.exe --list
# Look for  ST-LINK SN  : 003400343233510739363634
# This can be laster passed like
$ STM32_Programmer_CLI -c port=SWD "sn=003400343233510739363634" -w gen_3_0_handle.hex -rst
```
